{% extends 'base.html' %}
{% block title %}–°–ø–∏—Å–æ–∫ –ø–ª–∞—Ç–µ–∂–µ–π{% endblock %}


{% block content %}
{% load l10n %}
{% load filters %}
{% localize off %}
{% include 'includes/operator_menu.html' %}
<div class="container-fluid ">
{% include 'includes/switcher2.html' %}


  {% with request.resolver_match.view_name as view_name %}
    {% if view_name == 'deposit:incomings_filter' %}
       –í–∞—à —Ñ–∏–ª—å—Ç—Ä –Ω–∞ –ø–æ–ª—É—á–∞—Ç–µ–ª—è: {{ user.profile.my_filter }}
       <a class="changelink" href="{% url 'deposit:my_filter' %}">–ò–∑–º–µ–Ω–∏—Ç—å</a>
    {% endif %}

    <span class="row justify-content-start">
      <div class="col-6">
        <form method="GET">

          {% if search_form %}
            {{ search_form.as_p }}
          {% endif %}
          <input class="btn btn-success " type="submit" name="date_search" value="–ù–∞–π—Ç–∏">
        {% if filtered_total %}
<div class="alert alert-info" style="margin-bottom: 10px">
    <b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ñ–∏–ª—å—Ç—Ä—É:</b><br>
    <b>–í—Å–µ–≥–æ –ø–ª–∞—Ç–µ–∂–µ–π:</b> {{ filtered_total.count }}<br>
    <b>–°—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–µ–π:</b> {{ filtered_total.total_pay|floatformat:2 }}
</div>
{% endif %}
       </form>
      </div>
      <p id="last_id" hidden>{{ last_id }}</p>
      <p id="last_bad_id" hidden>{{ last_bad_id }}</p>
      <p id="filter" hidden>{{ filter }}</p>
      {% if view_name == 'deposit:incomings' or view_name == 'deposit:incomings_filter' %}
       <div class="col-3" role="alert" id="warnings" style="padding:  6px 0 6px 0; margin: 0 0 0 10px">
         <!-- –ó–¥–µ—Å—å –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
        </div>
      {% endif %}
    </span>


     {% include 'includes/paginator.html' %}
     <div class="container-fluid ">
     <table id="table" class="table table-bordered table-hover table-sm" style="font-size: 14px; line-height: 100%; padding: .1rem .1rem .1rem .1rem">
     <thead class="">
     <tr class="">
           <th>id</th>
           <th>T –ø—Ä–∏—Ö</th>
           <th>T –Ω–∞ —á–µ–∫–µ</th>
           <th>–ü–æ–ª—É—á–∞—Ç–µ–ª—å</th>
           <th>–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å</th>
           <th>Worker</th>
           <th>Pay</th>
           <th>–ë</th>
           <th>–¢—Ä-—è</th>
            <th>–ê–ø—Ä—É–≤</th>
           <th>–ë–∏—Ä–ø–∞–π</th>
       </tr>
     </thead>
     <tbody style="text-align: end" >
         {% for incoming in page_obj %}
         <tr title="{{incoming.comment|default_if_none:'' }}" id="pay{{ incoming.id }}"
                 {% if incoming.birpay_id or not incoming.birpay_id|default_if_none:'-'%}
                 class="table-success"
                 {% endif %}>

            <td>{% if  incoming.is_jail %}<span style="background-color: rgba(121,0,255,0.58)">üöìüöìüöìüöìüöì</span>{% endif %}
                <a class="changelink" href="{% url 'deposit:incoming_edit' incoming.id %}">{{ incoming.id }}</a>
                {% if incoming.comment %}
                  *
                {% endif %}
            </td>
            <td>{{ incoming.register_date|date:"d.m H:i" }}</td>
            <td>{{ incoming.response_date|date:"d.m H:i" }}</td>
            <td>{{ incoming.recipient }}</td>

            <td style="color: {{ incoming.color_font }}; background: {{ incoming.color_back }}">{{ incoming.sender }}</td>
            {% if incoming.worker == 'base2' %}
             <td style="background-color: crimson">{{ incoming.worker }}</td>
            {% else %}
                <td>{{ incoming.worker|default_if_none:'' }}</td>
            {% endif %}
            <td>{% if incoming.balance_mismatch %}<span style="color: #C20000">{{ incoming.pay }}</span>{% else %}{{ incoming.pay }}{% endif %}</td>
            <td{% if incoming.balance_mismatch %} style="background-color: #FFF9C4;"{% endif %}>
                {% if incoming.balance %}
                    {{ incoming.balance|floatformat:0  }}{% if incoming.balance and incoming.check_balance is not None and incoming.prev_balance is not None %} (<span {% if incoming.balance_mismatch %}style="color: #C20000" {% endif %}>{{ incoming.prev_balance|floatformat:0 }}</span>){% endif %}
                {% elif incoming.image %}
                    <a target="_blank" href="/media/{{ incoming.image }}">–ß–µ–∫</a>
                {% endif %}
            </td>

            <td title="{{ incoming.transaction }}">{{ incoming.transaction|default_if_none:""|make_list|slice:'-4:'|join:'' }}</td>
                    <td>{{ incoming.birpay_confirm_time|date:"d.m H:i" }}</td>
         {% load l10n %}
         {% localize off %}
            <td class="text-nowrap">
                <form action="{% url 'deposit:incomings' %}" method="post" class="birpay-link-form"
                      data-incoming-id="{{ incoming.id }}"
                      data-balance="{{ incoming.balance|default_if_none:'' }}"
                      data-check-balance="{{ incoming.check_balance|default_if_none:'' }}"
                      data-prev-balance="{{ incoming.prev_balance|default_if_none:'' }}"
                      data-pay="{{ incoming.pay|default_if_none:'' }}"
                      data-balance-mismatch="{% if incoming.balance_mismatch %}true{% else %}false{% endif %}">
                                    {% csrf_token %}
                    <input type="tel" style="margin-bottom: -10px; margin-top: -10px; font-size: 14px; height: 20px" minlength="0" maxlength="12" size="10" pattern="[0-9]+" value="{{ incoming.birpay_id|default_if_none:""  }}" name="{{ incoming.id }}-{{ view_name }}">
                    {% if incoming.birpay_id or not incoming.birpay_id|default_if_none:'-' %}
                      <button disabled style="margin-bottom: -10px; margin-top: -10px; height: 25px;font-size: small" type="submit" class="btn btn-success btn-sm">---</button>
                    {% else %}
                      <button style="margin-bottom: -10px; margin-top: -10px; height: 25px;font-size: small" type="submit" class="btn btn-warning btn-sm">Ok</button>
                    {% endif %}
                    <input type="hidden" name="confirm_balance_mismatch_{{ incoming.id }}" value="0" class="confirm-balance-mismatch">
                </form>
            </td>
         {% endlocalize %}

         </tr>
         {% endfor %}
     </tbody>
   </table>
   </div>
   {% include 'includes/paginator.html' %}
  {% endwith %}
</div>
{% endlocalize %}
{% endblock %}

{% block javascript %}
  {% with request.resolver_match.view_name as view_name %}
  {% if view_name != 'deposit:incomings_empty' and view_name != 'deposit:incomings_search'%}
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script>
                function getPosts() {
            $.ajax({
                url: '/get_posts/',
                type: 'get',
                dataType: 'json',
                data: {'filter': $('#filter').text() },
                success: function(response) {
                        var last_id = $('#last_id').text().replace(/\D/g, '')
                        var num = response[0].id

                        var count = num - last_id
                        var div = $('#warnings')
                        div.html(`–ù–æ–≤—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π: ${count}`);
                        if (count >= 1) {
                            div.addClass("alert alert-warning")
                        }
                        {% if  request.user.profile.view_bad_warning %}
                            var current_bad_id = response[0].last_bad_id
                            var last_bad_id = $('#last_bad_id').text().replace(/\D/g, '')
                            var count_bad_screen = current_bad_id - last_bad_id
                            console.log(current_bad_id)
                            console.log(last_bad_id)
                            console.log(count_bad_screen)
                            if (count_bad_screen > 0) {
                                alert('–ü—Ä–æ–±–ª–µ–º–∞ —Å —Ä–∞–±–æ—Ç–æ–π –º–∞–∫—Ä–æ—Å–∞!');
                                document.getElementById("last_bad_id").textContent=current_bad_id.toString();
                            }
                        {% endif %}

                }
            });
        }
        // –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –ø–æ—Å—Ç–æ–≤
        getPosts();
        setInterval(getPosts, 5000)
    </script>
    {% endif %}
    {% endwith %}

<script>
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞ –ø–µ—Ä–µ–¥ –ø—Ä–∏–≤—è–∑–∫–æ–π BirpayOrder
    document.addEventListener('DOMContentLoaded', function() {
        var forms = document.querySelectorAll('.birpay-link-form');
        forms.forEach(function(form) {
            form.addEventListener('submit', function(e) {
                var balanceMismatch = form.getAttribute('data-balance-mismatch') === 'true';
                var balance = form.getAttribute('data-balance');
                var checkBalance = form.getAttribute('data-check-balance');
                var incomingId = form.getAttribute('data-incoming-id');
                var confirmInput = form.querySelector('.confirm-balance-mismatch');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–æ—Ä–º–∞ –Ω–µ –æ—Ç–∫–ª—é—á–µ–Ω–∞ (–∫–Ω–æ–ø–∫–∞ –Ω–µ disabled)
                var submitButton = form.querySelector('button[type="submit"]');
                if (submitButton && submitButton.disabled) {
                    return; // –§–æ—Ä–º–∞ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞, –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤–≤–µ–¥–µ–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ (–Ω–µ –ø—É—Å—Ç–æ–µ)
                var input = form.querySelector('input[type="tel"]');
                if (!input || !input.value.trim()) {
                    return; // –ü—É—Å—Ç–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ, –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º
                }
                
                // –ï—Å–ª–∏ –±–∞–ª–∞–Ω—Å –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç –∏ –µ—â–µ –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ
                if (balanceMismatch && confirmInput && confirmInput.value === '0') {
                    var prevBalance = form.getAttribute('data-prev-balance');
                    var pay = form.getAttribute('data-pay');
                    var message = '‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –ù–µ—Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞!\n\n' +
                                  'Incoming ID: ' + incomingId + '\n' +
                                  (prevBalance ? '–ë—ã–ª–æ: ' + prevBalance + '\n' : '') +
                                  (pay ? '–ü–ª—é—Å: ' + pay + '\n' : '') +
                                  (checkBalance ? '–î–æ–ª–∂–Ω–æ –±—ã—Ç—å: ' + checkBalance + '\n' : '') +
                                  '–ê –ø–æ —Ñ–∞–∫—Ç—É: ' + balance + '\n\n' +
                                  '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø—Ä–∏–≤—è–∑–∞—Ç—å BirpayOrder —Å –Ω–µ—Å–æ–≤–ø–∞–¥–∞—é—â–∏–º –±–∞–ª–∞–Ω—Å–æ–º?';
                    
                    if (!confirm(message)) {
                        e.preventDefault(); // –û—Ç–º–µ–Ω—è–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã
                        return false;
                    } else {
                        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
                        if (confirmInput) {
                            confirmInput.value = '1';
                        }
                    }
                }
            });
        });
    });
</script>
{% endblock %}