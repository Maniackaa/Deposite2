{% extends 'base.html' %}
{% block title %}–°–ø–∏—Å–æ–∫ –ø–ª–∞—Ç–µ–∂–µ–π{% endblock %}

{% block content %}
{% load l10n %}
{% localize off %}
{% load filters %}
<script>
    function showRawData(orderId) {
        var data = JSON.parse(document.getElementById('rawdata-' + orderId).textContent);
        alert(JSON.stringify(data, null, 2));
    }
</script>

{% include 'includes/operator_menu.html' %}
<div class="container-fluid ">
    {% include 'includes/switcher2.html' %}

<div class="row mb-3">
  <div class="col-12">
    <form method="GET" class="form-inline flex-wrap gap-2 align-items-end" style="display: flex; flex-wrap: wrap; gap: 10px;">
      {% if search_form %}
        {% for field in search_form %}
          <div class="form-group mb-2" style="min-width: 180px; margin-right: 10px;">
            {{ field.label_tag }}{{ field }}
          </div>
        {% endfor %}
      {% endif %}
      <button class="btn btn-success mb-2" type="submit" name="date_search">–ù–∞–π—Ç–∏</button>
    </form>
  </div>
</div>

{% if birpay_stats %}
<table class="table table-bordered table-sm mb-2" style="width:auto; font-size:13px; margin-bottom:8px;">
    <tbody>
        <tr>
            <td><b>–í—Å–µ–≥–æ</b></td>
            <td>{{ birpay_stats.total }}</td>
            <td><b>–° incoming_id</b></td>
            <td>{{ birpay_stats.with_incoming }}</td>
            <td><b>–°—É–º–º–∞ incoming_pay</b></td>
            <td>{{ birpay_stats.sum_incoming_pay|floatformat:2 }}</td>
            <td><b>–°—É–º–º–∞ amount</b></td>
            <td>{{ birpay_stats.sum_amount|floatformat:2 }}</td>
            <td><b>–°—É–º–º–∞ delta</b></td>
            <td>{{ birpay_stats.sum_delta|floatformat:2 }}</td>
            <td><b>–°—Ç–∞—Ç—É—Å 0</b></td>
            <td>{{ birpay_stats.status_0 }}</td>
            <td><b>–°—Ç–∞—Ç—É—Å 1</b></td>
            <td>{{ birpay_stats.status_1 }}</td>
            <td><b>–°—Ç–∞—Ç—É—Å 2</b></td>
            <td>{{ birpay_stats.status_2 }}</td>
            <td><b>GPT%</b></td>
            <td>{{ birpay_stats.gpt_approve }}</td>
        </tr>
    </tbody>
</table>
{% endif %}


    {% include 'includes/paginator.html' %}
     <div class="container">
         <table id="table" class="table table-bordered table-hover table-sm" style="font-size: 14px; line-height: 100%; padding: .1rem .1rem .1rem .1rem">
            <thead>
                <tr>
                    <th>–Ω–∞—à incoming</th>
                    <th>–î–µ–ª—å—Ç–∞</th>
                    <th>—Å–º—Å</th>
                    <th>Merchant Tx ID</th>
                    <th>Created</th>
                    <th>–ó</th>
                    <th>Changed</th>
                    <th>Status</th>
                    <th>Amount</th>
                    <th>Card</th>
                    <th>Merchant</th>
                    <th>User</th>
                    <th>Customer Name</th>
                    <th>Operator</th>
                    <th>–ß–µ–∫</th>
                    <th>Raw Data</th>
                    <th>GPT Data</th>
                    <th>
                        <span title="–í—Ä–µ–º—è | –∫–∞—Ä—Ç–∞ | —Å—É–º–º–∞ | —Å–º—Å –æ–¥–Ω–∞ | –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –±—ã">GPT res</span>
                        {% if gpt_auto_approve %}
                            <a href="{% url 'users:toggle_option' 'gpt_auto_approve' %}">üü¢</a>
                        {% else %}
                            <a href="{% url 'users:toggle_option' 'gpt_auto_approve' %}">üî¥</a>
                        {% endif %}
                    </th>
                    <th>‚è¨</th>
                </tr>
            </thead>
            <tbody>
            {% for order in page_obj %}
                <tr>
                    <td>
                        {{ order.incoming_id|default_if_none:"" }} {{ order.incoming_pay|default_if_none:"" }}
                    </td>
                    <td>{{ order.delta|default_if_none:"" }}</td>
                    <td>{{ order.incoming_register_date|date:"H:i:s" }}</td>
                    <td {% if order.check_is_double %} style="background: red" {% endif %}>{{ order.merchant_transaction_id }}</td>
                    <td>{{ order.created_at|date:"Y-m-d H:i:s" }}</td>
                    <td>{{ order.delay|floatformat:0}}</td>
                    <td>{{ order.updated_at|date:"Y-m-d H:i:s" }}</td>
                    <td>{{ order.status }}</td>
                    <td>{{ order.amount }}</td>
                    <td>{{ order.card_number }}</td>
                    <td>{{ order.merchant_name }}</td>
                    <td>
                        {% if order.is_moshennik%}
                            <span style="background: red">{{ order.merchant_user_id }}</span>
                        {% else %}
                            {{ order.merchant_user_id }}
                        {% endif %}
                    </td>
                    <td>{{ order.customer_name }}</td>
                    <td>{{ order.operator|default_if_none:"" }}</td>
                    <td>
                        {% if order.check_file %}
                            <a href="{{ order.check_file.url }}" target="_blank">–ß–µ–∫</a>
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>
                        <a href="{% url 'deposit:birpay_order_raw' order.birpay_id %}">RAW</a>
                    </td>
                    <td>{{ order.gpt_data }}</td>
                    <td>{{ order.gpt_flags|as_bin }}</td>
                    <td>
                        <a href="#" onclick="toggleRawData({{ order.birpay_id }}, this); return false;">‚è¨</a>
                        <a href="{% url 'deposit:show_birpay_order_log' order.birpay_id %}" target="_blank">–ª–æ–≥</a>
                    </td>

                </tr>
            {% empty %}
                <tr>
                    <td colspan="14">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td>
                </tr>

            {% endfor %}
            </tbody>
         </table>
     </div>
   {% include 'includes/paginator.html' %}

</div>
{% endlocalize %}
    
                
    

                {% if duplicates %}
                    <div>
                        <b>–î—É–±–ª–∏–∫–∞—Ç—ã:</b>
                        <ul>
                        {% for order in duplicates %}
                            <li>ID: {{ order.id }}, Created: {{ order.created_at }}</li>
                        {% endfor %}
                        </ul>
                    </div>
                {% endif %}
        <pre>{{ raw_json_pretty }}</pre>
    <script>
function toggleRawData(birpayId, el) {
    // –ù–∞—Ö–æ–¥–∏–º —Å—Ç—Ä–æ–∫—É —Ç–∞–±–ª–∏—Ü—ã, –≥–¥–µ –∫–ª–∏–∫–Ω—É–ª–∏
    var tr = el.closest('tr');
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —É–∂–µ –µ—Å—Ç—å —Å—Ç—Ä–æ–∫–∞ —Å raw-–¥–∞–Ω–Ω—ã–º–∏ –ø–æ—Å–ª–µ —ç—Ç–æ–π?
    var next = tr.nextElementSibling;
    if (next && next.classList.contains('rawdata-row')) {
        // –ï—Å–ª–∏ –µ—Å—Ç—å ‚Äî –ø—Ä–æ—Å—Ç–æ —Å–∫—Ä—ã–≤–∞–µ–º/—É–¥–∞–ª—è–µ–º
        next.remove();
        return;
    }

    // –£–¥–∞–ª—è–µ–º –¥—Ä—É–≥–∏–µ —Ä–∞—Å–∫—Ä—ã—Ç—ã–µ rawdata-—Å—Ç—Ä–æ–∫–∏ (–ø–æ –∂–µ–ª–∞–Ω–∏—é)
    document.querySelectorAll('.rawdata-row').forEach(function(row){
        row.remove();
    });

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä
    var loaderRow = document.createElement('tr');
    loaderRow.className = 'rawdata-row';
    loaderRow.innerHTML = '<td colspan="18">–ó–∞–≥—Ä—É–∑–∫–∞...</td>';
    tr.parentNode.insertBefore(loaderRow, tr.nextSibling);

    // –î–µ–ª–∞–µ–º AJAX-–∑–∞–ø—Ä–æ—Å
    fetch('/birpay_orders/info/' + birpayId + '/')
        .then(response => response.text())
        .then(html => {
            loaderRow.innerHTML = '<td colspan="18">' + html + '</td>';
        })
        .catch(error => {
            loaderRow.innerHTML = '<td colspan="18">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</td>';
        });
}
</script>
{% endblock %}
