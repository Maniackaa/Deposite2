{% load l10n %}
{% localize off %}
{% load filters %}
    {% load static %}
<div class="" style="align-items: flex-start; gap: 30px;">

  <div class="row">
    <div class="col-4">

        <div class="card row" style=""><b>Обновлено:</b><br>{{ object.updated_at|date:"Y-m-d H:i:s" }}</div>
        <div class="card row" style="">
            <b>UserId: {{ object.merchant_user_id }}</b><br>
            {{ object.customer_name }}<br>
            Апрув {{ object.user_order_percent }}%: {{ object.user_orders_1 }}/{{ object.total_orders }}
        </div>
        <div class="card row" style=""><b>Возможные смс:</b><br>
            {% for  incoming in object.incomings.all %}
                <div class="row">
                    {{ incoming.id }}<img onclick="copyTextToClipboard({{ incoming.id }})" style="opacity: 0.5; width: 25px; height: 25px; object-fit: contain;" src="{% static '/img/copy.png' %}">{{ incoming.pay }} azn {{ incoming.response_date|date:"H:i" }} {{ incoming.recipient }}
                </div>
            {% endfor %}
        </div>
        <div class="card row" style=""><b>Gpt данные: {{ object.gpt_flags|as_bin }}</b><br>
            amount: {{ gpt_data|get_item:"amount" }}<br>
            Дата: : {{ gpt_data|get_item:"create_at" }}<br>
            Получатель: : {{ gpt_data|get_item:"recipient" }}<br>
            Коммент: : {{ gpt_data|get_item:"comment" }}<br>
        </div>
    </div>
    <div class="col-4">
      <div class="row">

            <!-- Основное изображение -->
            <h3>Чек заказа (ID {{ object.id }}):</h3>
            <span>M Tx ID {{ object.merchant_transaction_id }}:  b_id {{ object.birpay_id }}<span><br>
            {% if object.check_file %}
              <a href="{{ object.check_file.url }}" target="_blank">
                 <img src="{{ object.check_file.url }}"
                     style="max-width:100%; max-height:100%; background: #eee; cursor: pointer;"
                     onerror="this.src=''; this.alt='нет изображения';">
              </a>
            {% else %}
              <span>Нет изображения чека</span>
            {% endif %}

      </div>
    </div>

      <div class="col-4">
          <!-- Дубликаты в ряд -->
            <h5>Дубликаты ({{ duplicates|length }})</h5>

              {% for double_order in duplicates %}
                <div class="row" style="text-align: left;">
                  <b>Заказ №{{ double_order.merchant_transaction_id }} от {{ double_order.created_at|date:"H:i:s" }}</b><br>
                    Статус: {{ double_order.status }}<br>
                      Сумма {{ double_order.amount }}<br>
                      {% if double_order.incoming.id  %}Смс {{ double_order.incoming.id }} от {{ double_order.incoming.register_date|date:"H:i:s" }} на {{ double_order.incoming.pay }}{% endif %}

                </div>
              {% empty %}
                <span>Дубликаты не найдены.</span>
              {% endfor %}


      </div>
  </div>
</div>

{% endlocalize %}

<script>
    function showCopyToast() {
        var toast = document.getElementById('copy-toast');
        toast.style.display = 'block';
        setTimeout(function() {
            toast.style.opacity = 1;
        }, 10);
        setTimeout(function() {
            toast.style.opacity = 0;
            setTimeout(function() {
                toast.style.display = 'none';
            }, 300);
        }, 1200);
    }
    
    function copyTextToClipboard(text) {
        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(text).then(
                function() { showCopyToast(); },
                function(err) { alert('Ошибка копирования: ' + err); }
            );
        } else {
            var textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.top = "-1000px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
    
            try {
                document.execCommand('copy');
                showCopyToast();
            } catch (err) {
                alert('Ошибка копирования: ' + err);
            }
    
            document.body.removeChild(textArea);
        }
    }
</script>