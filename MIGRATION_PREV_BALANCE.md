# Миграция: Расчет prev_balance и check_balance при создании Incoming

## Изменения

### 1. Добавлены поля в модель `Incoming`

**Файл:** `backend_deposit/deposit/models.py`

Добавлены два новых поля:
- `prev_balance` (FloatField) - Предыдущий баланс для того же получателя
- `check_balance` (FloatField) - Расчетный баланс (prev_balance + pay)

```python
prev_balance = models.FloatField('Предыдущий баланс', null=True, blank=True, db_index=True)
check_balance = models.FloatField('Расчетный баланс', null=True, blank=True)
```

### 2. Добавлен метод `calculate_balance_fields()`

**Файл:** `backend_deposit/deposit/models.py` (строки 236-261)

Метод вычисляет `prev_balance` и `check_balance` на основе предыдущих записей для того же получателя.

**Логика:**
- Находит предыдущую запись для того же `recipient`
- Сортировка: `response_date DESC`, `balance DESC`, `id DESC`
- Если найдена предыдущая запись с балансом → устанавливает `prev_balance` и вычисляет `check_balance = prev_balance + pay`
- Если не найдена → устанавливает `None`

### 3. Переопределен метод `save()`

**Файл:** `backend_deposit/deposit/models.py` (строки 263-295)

Метод `save()` теперь:
1. Вычисляет `prev_balance` и `check_balance` перед сохранением
2. Сохраняет запись
3. При изменении баланса или получателя пересчитывает первые 10 последующих записей для того же получателя

### 4. Обновлены SQL-запросы в views.py

**Файл:** `backend_deposit/deposit/views.py`

#### `incoming_list()` (строки 390-424)
- Убраны вычисления через `LAG()` оконные функции
- Теперь просто выбираются значения `prev_balance` и `check_balance` из БД
- Сохранен JOIN с `deposit_colorbank` для получения `color_font` и `color_back`

#### `IncomingEmpty.get_queryset()` (строка 456)
- Убраны аннотации через `Window()` функции
- Теперь используется обычный queryset

#### `IncomingFiltered.get_queryset()` (строки 514-532)
- Убраны вычисления через `LAG()` оконные функции
- Теперь просто выбираются значения из БД

### 5. Создана миграция

**Файл:** `backend_deposit/deposit/migrations/0010_incoming_prev_balance_check_balance.py`

Добавляет поля `prev_balance` и `check_balance` в таблицу `deposit_incoming`.

### 6. Создана команда управления для пересчета данных

**Файл:** `backend_deposit/deposit/management/commands/recalculate_balance_fields.py`

Команда для пересчета `prev_balance` и `check_balance` для всех существующих записей.

**Использование:**
```bash
python manage.py recalculate_balance_fields
python manage.py recalculate_balance_fields --batch-size 500
python manage.py recalculate_balance_fields --recipient "1234"
```

---

## Преимущества изменений

1. **Производительность:**
   - Убраны тяжелые оконные функции `LAG()` из SQL-запросов
   - Значения вычисляются один раз при создании/обновлении
   - Запросы к БД стали проще и быстрее

2. **Надежность:**
   - Значения сохраняются в БД и не зависят от сложности SQL-запросов
   - Легче отлаживать и проверять значения

3. **Масштабируемость:**
   - Не нужно вычислять значения при каждом запросе страницы
   - Можно индексировать поля для быстрого поиска

---

## Недостатки и ограничения

1. **При изменении баланса:**
   - Пересчитываются только первые 10 последующих записей
   - Для полного пересчета нужно запустить команду `recalculate_balance_fields`

2. **При изменении получателя:**
   - Пересчитываются только первые 10 последующих записей для нового получателя
   - Старые записи для предыдущего получателя не пересчитываются автоматически

3. **Производительность при создании:**
   - При создании новой записи выполняется дополнительный запрос для поиска предыдущей записи
   - Это может замедлить создание при большом количестве записей для одного получателя

---

## Шаги для применения изменений

1. **Применить миграцию:**
   ```bash
   python manage.py migrate deposit
   ```

2. **Пересчитать существующие данные:**
   ```bash
   python manage.py recalculate_balance_fields
   ```

3. **Проверить работу:**
   - Создать новую запись `Incoming` и проверить, что `prev_balance` и `check_balance` вычисляются
   - Проверить отображение в шаблонах `incomings_list.html` и `incomings_list_stat.html`

---

## Обратная совместимость

- Старые записи без `prev_balance` и `check_balance` будут иметь `NULL` значения
- Шаблоны уже проверяют наличие значений через `{% if incoming.balance %}`, так что это безопасно
- После пересчета через команду все записи будут иметь корректные значения

---

## Примечания

- При изменении баланса существующей записи автоматически пересчитываются только первые 10 последующих записей
- Для полного пересчета всех зависимых записей используйте команду `recalculate_balance_fields`
- Команда поддерживает батчевую обработку для оптимизации производительности

