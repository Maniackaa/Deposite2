# Анализ изменения статусов BirpayOrder

## Поля статусов

- **`status`** (SmallIntegerField) - "Статус на сервере birpay" (0=pending, 1=approve, 2=decline/hide)
- **`status_internal`** (SmallIntegerField) - "Наш статус" (default=0, -2=hide)

---

## Места изменения статусов

### 1. **`deposit/tasks.py` → `process_birpay_order()`** (строки 438-492)

**Функция:** Синхронизация данных из Birpay API

**Изменяет:** `status`

**Логика:**
- При создании нового заказа: устанавливает `status` из данных API (`data['status']`)
- При обновлении существующего заказа: обновляет `status`, если значение изменилось
- Использует `setattr()` для обновления всех полей из `order_data`, включая `status`

**Код:**
```python
order_data = {
    ...
    'status': data['status'],  # строка 459
    ...
}
# При обновлении (строки 476-483):
if not created:
    for field, value in order_data.items():
        if getattr(order, field) != value:
            setattr(order, field, value)  # Может изменить status
            updated = True
    if updated:
        order.save()
```

**Вызывается из:**
- `refresh_birpay_data()` (строка 672) - периодическая задача синхронизации

---

### 2. **`deposit/views.py` → `BirpayPanelView.post()`** (строки 1634-1749)

**Функция:** Обработка действий оператора в панели Birpay

**Изменяет:** `status`, `status_internal`

**Логика:**

#### a) Действие `hide` (строки 1689-1693):
```python
if action == 'hide':
    order.status_internal = -2
    update_fields.extend(['status_internal'])
    order.save(update_fields=update_fields)
```
- Устанавливает `status_internal = -2` (скрытие заказа)

#### b) Действие `approve` (строки 1697-1743):
```python
elif action == 'approve':
    # Проверки...
    response = approve_birpay_refill(pk=order.birpay_id)
    if response.status_code == 200:
        order.status = 1           # строка 1730
        order.status_internal = 1  # строка 1731
        # ... другие поля
        order.save()  # строка 1740
```
- Устанавливает `status = 1` и `status_internal = 1` после успешного подтверждения в Birpay API

#### c) Действие `pending` (строка 1694-1696):
- Не изменяет статусы напрямую, только сохраняет другие изменения

---

### 3. **`deposit/tasks.py` → `send_image_to_gpt_task()`** (строки 496-668)

**Функция:** Автоматическое подтверждение после распознавания чека GPT

**Изменяет:** НЕ изменяет `status` и `status_internal` напрямую

**Логика:**
- Вызывает `approve_birpay_refill(pk=order.birpay_id)` (строка 648)
- НО не устанавливает `status` или `status_internal` в коде
- Статус обновится при следующей синхронизации через `process_birpay_order()`

**Потенциальная проблема:**
- После успешного `approve_birpay_refill()` статус в Birpay API изменится на 1
- Но локально в БД `status` останется прежним до следующей синхронизации
- Это может привести к рассинхронизации

---

## Сводная таблица изменений

| Место | status | status_internal | Условие |
|:------|:------:|:---------------:|:--------|
| `process_birpay_order()` | ✅ | ❌ | При синхронизации с API |
| `BirpayPanelView.post()` → `hide` | ❌ | ✅ = -2 | Действие hide |
| `BirpayPanelView.post()` → `approve` | ✅ = 1 | ✅ = 1 | После успешного approve_birpay_refill() |
| `send_image_to_gpt_task()` | ❌ | ❌ | Только вызывает API, не обновляет локально |
| Django Admin | ✅ | ✅ | Ручное редактирование через админку |

### 4. **Django Admin** (`deposit/admin.py` → `BirpayOrderAdmin`)

**Функция:** Стандартная админка Django

**Изменяет:** `status`, `status_internal` (через форму редактирования)

**Логика:**
- Через стандартную форму редактирования в админке можно изменить любые поля модели
- Нет ограничений на изменение статусов
- Нет валидации или синхронизации с Birpay API

**Риск:** 
- Можно изменить статус вручную в админке, что приведет к рассинхронизации с Birpay API
- Нет логирования изменений через админку

---

## Проблемы и несоответствия

### 1. **Отсутствие обновления статуса после автоматического подтверждения**

В `send_image_to_gpt_task()`:
- Вызывается `approve_birpay_refill()` (API обновлен)
- Но локальный `status` не обновляется
- Обновится только при следующей синхронизации через `process_birpay_order()`

**Риск:** Временная рассинхронизация между локальной БД и Birpay API.

### 2. **Отсутствие проверок при изменении статуса**

В `BirpayPanelView` нет проверок:
- Можно ли изменить статус (например, если уже подтвержден)
- Соответствует ли статус реальному состоянию в Birpay API

### 3. **Изменение статусов через Django Admin**

- Можно изменить `status` и `status_internal` вручную через админку
- Нет валидации или синхронизации с Birpay API
- Нет логирования изменений
- Может привести к полной рассинхронизации с внешним API

**Риск:** Критический - можно случайно изменить статус, что приведет к проблемам в бизнес-логике.

---

## Рекомендации

1. **Обновлять статус после автоматического подтверждения:**
   - В `send_image_to_gpt_task()` после успешного `approve_birpay_refill()` устанавливать `status = 1` и `status_internal = 1`

2. **Добавить проверки:**
   - Проверять текущий статус перед изменением
   - Валидировать возможность изменения статуса
   - Проверять, можно ли изменить статус (например, если уже подтвержден)

3. **Добавить логирование:**
   - Логировать все изменения статусов с указанием источника изменения

4. **Ограничить изменение статусов в админке:**
   - Сделать поля `status` и `status_internal` readonly в админке
   - Или добавить кастомную валидацию при сохранении в админке
   - Добавить логирование всех изменений через админку
